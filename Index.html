<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç©ç®—é›»å“ï¼ˆçµ±åˆç‰ˆï¼‰</title>
<style>
:root{
  --bg:#0b0b0c;
  --card:#14171a;
  --muted:#9aa4ad;
  --accent-1:#1e90ff;
  --orange:#ff9500;
  --dark-btn:#0b0b0c; /* æ–‡å­—è‰²ã‚’é»’ã«çµ±ä¸€ */
  font-family:-apple-system, "Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
.app{max-width:820px;margin:8px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:800;font-size:18px}
.sub{font-size:13px;color:var(--muted)} 

/* top: two-column */
.top{display:flex;gap:12px;align-items:flex-start}
.left{flex:2;background:linear-gradient(180deg,var(--card),#0c0f11);border-radius:12px;padding:10px;min-height:180px;max-height:340px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
.right{width:240px;background:linear-gradient(180deg,#07080a,#0b0d10);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);position:relative}

/* entry */
.entry{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
.entry .label{font-weight:700;font-size:15px}
.entry .price{font-variant-numeric:tabular-nums;color:var(--muted);min-width:120px;text-align:right}
.removeBtn{background:transparent;border:0;color:#ff6b6b;font-weight:800;cursor:pointer;margin-left:8px}

/* totals */
.tot-label{font-size:13px;color:var(--muted)}
.tot-value{font-weight:800;font-size:20px;text-align:right;margin-top:4px}

/* buttons */
.grid-wrap{background:transparent;border-radius:12px;padding:8px}
.buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.btn{
  border-radius:12px;
  padding:12px 8px;
  min-height:64px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:var(--dark-btn); 
  font-weight:800;
  border:1px solid rgba(0,0,0,0.1); 
  box-shadow:0 8px 18px rgba(0,0,0,0.6);
  transition:transform .06s;
}
.btn:active{transform:translateY(2px);filter:brightness(0.95)} 

/* Cãƒœã‚¿ãƒ³ (æ—¢å­˜ã®æš–è‰²) */
.btn.dark{
    background:linear-gradient(180deg, #ff7f50, #ff6347); /* èµ¤ã¿ã®å¼·ã„ã‚ªãƒ¬ãƒ³ã‚¸/ã‚³ãƒ¼ãƒ©ãƒ«ç³» */
    color:#fff; 
    border:1px solid rgba(255,255,255,0.1); 
}
/* ACãƒœã‚¿ãƒ³å°‚ç”¨ (ã•ã‚‰ã«æ¿ƒã„æš–è‰²) */
.btn.ac-dark{
    background:linear-gradient(180deg, #ff4500, #cc3700); /* ã‚ªãƒ¬ãƒ³ã‚¸ãƒ¬ãƒƒãƒ‰ã‹ã‚‰æ·±ã„èµ¤ã¸ */
    color:#fff; 
    border:1px solid rgba(255,255,255,0.2); 
}
/* C/ACãƒœã‚¿ãƒ³é…ç½®ã®ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
.btn-placeholder{
    background:transparent;
    padding:12px 8px;
    min-height:64px;
    border-radius:12px;
    border:1px solid transparent; 
}

/* free-group */
.free-group{margin-top:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px}
.free-row{display:flex;gap:8px;align-items:center}
/* é‡‘é¡å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.free-input{flex:1;background:#202327;border:1px solid rgba(255,255,255,0.2);padding:10px;border-radius:8px;text-align:right;color:#fff;font-size:16px}

/* è‡ªç”±å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚¿ã‚¤ãƒ« */
.coeff-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;padding:0 8px}
/* è‡ªç”±å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.coeff{
  background:#fff;
  border:1px solid #fff;
  color:var(--dark-btn); 
  padding:12px 8px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  min-height:64px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  box-shadow:0 8px 18px rgba(0,0,0,0.6);
  transition:transform .06s;
}
.coeff:active{transform:translateY(2px);filter:brightness(0.95)}

/* modal - è¨­å®šç”»é¢ã®æ–‡å­—ã¨ãƒœã‚¿ãƒ³ã‚’å¤§ããã™ã‚‹ä¿®æ­£ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90;background:linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6))}
.panel{
  width:94%;
  max-width:760px;
  max-height:86vh;
  overflow:auto;
  background:#0b0f12;
  border-radius:12px;
  padding:28px; 
  border:1px solid rgba(255,255,255,0.04);
  font-size:1.2em; 
}
.panel h3{
    font-size:1.8em; 
    margin-top:0;
}
.form-row{
  display:flex;
  gap:16px; 
  align-items:center;
  margin-bottom:16px; 
}
.form-row label{
    font-size:1.1em;
    min-width:180px !important; 
    color:var(--muted);
}
.form-row input[type="text"], .form-row input[type="number"], .form-row select{
  padding:16px; 
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.04);
  background:transparent;
  color:#fff;
  font-size:1.1em; 
}

/* è¨­å®šç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ã®CSS */
.config-header {
    display: flex;
    gap: 16px; 
    align-items: center;
    margin-bottom: 8px; 
    padding-left: 36px; 
    font-size: 1.1em;
}
.config-header > div {
    font-weight: 700;
}


/* PC/Tabletã§ã®è¨­å®šå…¥åŠ›æ¬„ã®å¹…æ¯”ç‡èª¿æ•´ */
.form-row #buttonConfig input[type="text"],
.form-row #freeConfig input[type="text"] {
    flex-grow: 3; 
    flex-shrink: 1;
}
.form-row #buttonConfig input[type="number"],
.form-row #freeConfig input[type="number"] {
    flex-grow: 2; 
    flex-shrink: 1;
    text-align: right;
}
/* åŸºæœ¬è¨­å®šã®å…¥åŠ›æ¬„ã¯ãƒ•ãƒ«å¹… */
.form-row input[type="number"]#taxInput,
.form-row select#roundMethod {
    flex: 1;
}

.small{font-size:13px;color:var(--muted)}

.modal .action-btn{
    padding:16px 12px; 
    font-size:1.1em; 
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®èª¿æ•´ (iPhoneãªã©ã®ç‹­ã„ç”»é¢) */
@media(max-width:520px){ 
    .right{width:42%} 
    .btn{min-height:56px;padding:10px} 
    .entry .price{min-width:90px} 
    
    /* è¨­å®šç”»é¢ã®UIè¦ç´ ã‚’ç¸®å° */
    .panel{padding:18px; font-size:1em;}
    .panel h3{font-size:1.5em;}
    .form-row{gap:8px;} 
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚èª¿æ•´ */
    .config-header{
        font-size: 0.9em;
        gap: 8px;
        padding-left: 24px;
    }
    
    /* å®šæ•°/è‡ªç”±ãƒœã‚¿ãƒ³ã®è¨­å®šè¡Œï¼ˆæ¨ªä¸¦ã³ã‚’ç¶­æŒã™ã‚‹è¨­å®šï¼‰ */
    .form-row > div:first-child{ /* Index number */
        width: 24px !important; 
        font-size: 1em !important;
        flex-shrink: 0;
    }
    .form-row input[type="text"], 
    .form-row input[type="number"], 
    .form-row select{
        padding: 10px; 
        font-size: 0.9em; 
    }
    /* Tax/Roundã®ãƒ©ãƒ™ãƒ«ã¨å…¥åŠ›æ¬„ã¯ç¸¦ç©ã¿ */
    .form-row:not(#buttonConfig .form-row):not(#freeConfig .form-row) {
        flex-wrap: wrap; 
    }
    .form-row:not(#buttonConfig .form-row):not(#freeConfig .form-row) > label {
        min-width:100% !important;
        margin-bottom: -4px;
    }
    .form-row input[type="number"]#taxInput,
    .form-row select#roundMethod {
        flex: 1 1 100%; 
    }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">ç©ç®—é›»å“ï¼ˆçµ±åˆç‰ˆï¼‰</div>
      <div class="sub">é»’åŸºèª¿ãƒ»24å®šæ•°ãƒ»è‡ªç”±å…¥åŠ›4ã¤ãƒ»ä¸¸ã‚è¨­å®š</div>
    </div>
    <div>
      <button id="openSettings" class="action-btn" style="padding:8px 10px;font-size:13px">âš™ è¨­å®š</button>
    </div>
  </div>

  <div class="top">
    <div class="left" id="stack"></div>

    <div class="right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tot-label">ç¨æŠœåˆè¨ˆ</div>
        <div class="tot-value" id="preTax">0 å††</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="tot-label">æ¶ˆè²»ç¨ (<span id="taxRate">10</span>%)</div>
        <div class="tot-value" id="tax">0 å††</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="tot-label">åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div>
        <div class="tot-value" id="total">0 å††</div>
      </div>
    </div>
  </div>

  <div class="grid-wrap">
    <div class="buttons" id="buttonsArea" aria-hidden="false"></div>
  </div>
  
  <div class="grid-wrap" style="margin-top:10px;">
    <div class="buttons" id="controlBtnsArea">
      </div>
  </div>
  
  <div class="free-group" aria-label="è‡ªç”±å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ—" style="margin-top:10px;">
    <div style="font-size:13px;color:var(--muted);">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ä¸‹ã®è©²å½“æ›ã‘ç‡ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</div>
    <div class="free-row">
      <input id="freeValue" class="free-input" type="number" placeholder="é‡‘é¡ã‚’å…¥åŠ›ï¼ˆå††ï¼‰" min="0" step="1" />
    </div>
  </div>

  <div class="coeff-row" id="freeBtnsArea">
    </div>
  
</div>

<div class="modal" id="modal">
  <div class="panel">
    <h3>è¨­å®š</h3>

    <div class="form-row">
      <label>æ¶ˆè²»ç¨ç‡ï¼ˆï¼…ï¼‰</label>
      <input id="taxInput" type="number" min="0" step="0.1">
    </div>

    <div class="form-row">
      <label>å°æ•°ç‚¹ä»¥ä¸‹ã®å‡¦ç†</label>
      <select id="roundMethod">
        <option value="floor">åˆ‡ã‚Šæ¨ã¦</option>
        <option value="round">å››æ¨äº”å…¥</option>
        <option value="ceil">åˆ‡ã‚Šä¸Šã’</option>
      </select>
    </div>

    <div style="margin:16px 0;color:var(--muted)">å®šæ•°ãƒœã‚¿ãƒ³ï¼ˆ24å€‹ï¼‰ã®åå‰ã¨é‡‘é¡ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="config-header">
      <div style="flex: 3;">åå‰</div>
      <div style="flex: 2; text-align: right;">é‡‘é¡ï¼ˆå††ï¼‰</div>
    </div>
    <div id="buttonConfig"></div>

    <hr style="border-color:rgba(255,255,255,0.03);" />

    <div style="margin:16px 0;color:var(--muted)">è‡ªç”±ãƒœã‚¿ãƒ³ï¼ˆ4å€‹ï¼‰ - åå‰ã¨ä¿‚æ•°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="config-header">
      <div style="flex: 3;">åå‰</div>
      <div style="flex: 2; text-align: right;">ä¿‚æ•°</div>
    </div>
    <div id="freeConfig"></div>

    <div style="display:flex;gap:16px;margin-top:24px;">
      <button id="saveSettingsBtn" class="action-btn" style="background:#0b8a44;border:none; color: #fff;">ä¿å­˜</button>
      <button id="closeModal" class="action-btn" style="background:#222;color:#fff">é–‰ã˜ã‚‹</button>
    </div>
    
    <hr style="border-color:rgba(255,255,255,0.03); margin-top: 24px;" />
    
    <div style="margin:16px 0;color:var(--muted)">**è¨­å®šã®åŒæœŸãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**</div>
    <div style="display:flex;gap:16px;margin-top:8px;">
        <button id="exportSettingsBtn" class="action-btn" style="background:#555;border:none; color: #fff; flex:1;">è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</button>
        <button id="importBtn" class="action-btn" style="background:#4070ff;border:none; color: #fff; flex:1;">è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (JSON)</button>
        <input type="file" id="importFile" accept=".json" style="display:none;" />
    </div>
    <div style="margin-top:20px;font-size:1em;color:var(--muted)">
      â€»ã€Œã‚³ãƒ³ã‚µãƒ¼ãƒˆã€ã‚’å«ã‚€é …ç›®ã¯å¸¸ã«100å††æœªæº€ã‚’åˆ‡ä¸Šã’ã—ã¾ã™ï¼ˆå„ªå…ˆï¼‰ã€‚Cã¯ç›´å‰ã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã—ã€ACã¯ç©ç®—ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚
    </div>
  </div>
</div>

<script>
/* ===== defaults & storage keys ===== */
const DEFAULT = {
  taxRate: 10,
  roundMethod: "floor",
  buttons: [
    {name:"å®šæœŸUP", price:9818},
    {name:"å®šæœŸGP", price:12273},
    {name:"æ™®é€šUP", price:11193},
    {name:"æ™®é€šGP", price:13647},
    {name:"éŸ³æ•™å‚™å“UP", price:6382},
    {name:"éŸ³æ•™å‚™å“GP", price:7855},
    {name:"ç´èª¿UP", price:5891},
    {name:"ç´èª¿GP", price:8836},
    {name:"ä¸­å¤ç´èª¿UP", price:5891},
    {name:"ä¸­å¤ç´èª¿GP", price:8836},
    {name:"ã‚³ãƒ³ã‚µãƒ¼ãƒˆãƒ¤ãƒãƒ", price:16100},
    {name:"ã‚³ãƒ³ã‚µãƒ¼ãƒˆãã®ä»–", price:16900},
    {name:"å‡ºå¼µè²»3000", price:2356},
    {name:"å‡ºå¼µè²»3500", price:2847},
    {name:"å‡ºå¼µè²»4000", price:3338},
    {name:"ãƒ¤ãƒãƒãƒ›ãƒ¼ãƒ«", price:12764},
    {name:"åå¤å±‹åº—UP", price:6382},
    {name:"åå¤å±‹åº—GP", price:7953},
    {name:"RPS UP", price:6382},
    {name:"RPS GP", price:8836},
    {name:"å­¦æ ¡UP", price:5891},
    {name:"å­¦æ ¡GP", price:7265},
    {name:"å­¦æ ¡CF/S", price:8542},
    {name:"å­¦æ ¡SW/B", price:8935} // 24å€‹ç›®
  ],
  freeButtons: [
    {name:"ä¿®ç†å‰²å¢—", coeff:0.8836},
    {name:"ã‚¯ãƒ¬ãƒ¼ãƒ ", coeff:0.6873},
    {name:"éƒ¨å“ä»£", coeff:1},
    {name:"ç«‹ä¼šã„", coeff:0.864}
  ]
};
const CFG_KEY = "rewardcalc_cfg_v_integrated";
const ENTRIES_KEY = "rewardcalc_entries_v_integrated";

/* ===== state ===== */
let cfg = JSON.parse(localStorage.getItem(CFG_KEY) || "null") || DEFAULT;
let entries = JSON.parse(localStorage.getItem(ENTRIES_KEY) || "[]");

// æ—¢å­˜ã®è¨­å®šã«æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
if (cfg.buttons.length < DEFAULT.buttons.length) {
    const startIdx = cfg.buttons.length;
    for (let i = startIdx; i < DEFAULT.buttons.length; i++) {
        cfg.buttons.push(DEFAULT.buttons[i]);
    }
    saveCfg(); 
}

/* ===== elems ===== */
const buttonsArea = document.getElementById("buttonsArea");
const controlBtnsArea = document.getElementById("controlBtnsArea"); 
const stack = document.getElementById("stack"); 
const preTaxEl = document.getElementById("preTax");
const taxEl = document.getElementById("tax");
const totalEl = document.getElementById("total");
const taxRateSpan = document.getElementById("taxRate");
const freeValue = document.getElementById("freeValue");
const freeBtnsArea = document.getElementById("freeBtnsArea");

/* ===== helpers ===== */
function fmt(n){ return Number(n).toLocaleString() + " å††"; }
function toInt(v){ return Math.round(Number(v) || 0); }
function isConcert(n){ return String(n || "").includes("ã‚³ãƒ³ã‚µãƒ¼ãƒˆ"); }

function applyRoundMethod(value, method){
  if(method === "ceil") return Math.ceil(value);
  if(method === "round") return Math.round(value);
  return Math.floor(value);
}
function roundItem(name, val){
  if(isConcert(name)){
    return Math.ceil(val / 100) * 100;
  }
  return applyRoundMethod(val, cfg.roundMethod || "floor");
}

function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
function saveEntries(){ localStorage.setItem(ENTRIES_KEY, JSON.stringify(entries)); }

// æœ€ä¸Šéƒ¨ã«ã‚¸ãƒ£ãƒ³ãƒ—ã•ã›ã‚‹å…±é€šé–¢æ•°
function jumpToTop(){
    stack.scrollTop = 0; 
    window.scrollTo(0, 0); 
}

/* ===== render buttons grid (24 constants) ===== */
function renderButtons(){
  buttonsArea.innerHTML = "";
  
  const COLOR_LIGHT = 'linear-gradient(180deg, hsl(200, 85%, 90%), hsl(200, 85%, 80%))'; 
  const COLOR_DARK = 'linear-gradient(180deg, hsl(200, 70%, 60%), hsl(200, 70%, 50%))';  

  for(let i=0;i<24;i++){ 
    const col = i % 4;
    const btn = document.createElement("button");
    btn.className = "btn";

    const isDark = (col % 2 === 0);
    btn.style.background = isDark ? COLOR_DARK : COLOR_LIGHT;
    btn.style.color = isDark ? '#fff' : 'var(--dark-btn)';
    
    const b = cfg.buttons[i]; 
    const priceColor = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)';
    btn.innerHTML = `<div style="font-size:14px">${escapeHtml(b.name)}</div><div style="font-size:13px;margin-top:6px;color:${priceColor}">${b.price? b.price.toLocaleString()+' å††':''}</div>`;
    btn.addEventListener("click", ()=> {
      const displayName = String(b.name).includes("å‡ºå¼µè²»") ? "å‡ºå¼µè²»" : b.name || "ç„¡å";
      const price = roundItem(b.name, Number(b.price||0));
      addEntry({type:"preset", name:displayName, price});
      setTimeout(jumpToTop, 300); 
    });
    
    buttonsArea.appendChild(btn);
  }
}

/* ===== render control buttons (C/AC) - æ–°è¨­ ===== */
function renderControlButtons() {
    controlBtnsArea.innerHTML = "";

    const empty1 = document.createElement("div");
    empty1.className = "btn-placeholder";

    const empty2 = document.createElement("div");
    empty2.className = "btn-placeholder";

    const btnC = document.createElement("button");
    btnC.className = "btn dark"; 
    btnC.innerHTML = `<div style="font-size:16px;color:#fff;">C</div><div style="font-size:12px;margin-top:6px;color:#fff">ç›´å‰ã®å–ã‚Šæ¶ˆã—</div>`;
    btnC.addEventListener("click", ()=> {
        if(entries.length>0) entries.pop();
        saveEntries(); renderStack(); renderTotals();
        setTimeout(jumpToTop, 100); 
    });

    const btnAC = document.createElement("button");
    btnAC.className = "btn ac-dark"; 
    btnAC.innerHTML = `<div style="font-size:14px;color:#fff;">AC</div><div style="font-size:12px;margin-top:6px;color:#fff">å…¨ã¦ã‚¯ãƒªã‚¢</div>`;
    btnAC.addEventListener("click", ()=> {
        entries=[]; 
        saveEntries(); 
        renderStack(); 
        renderTotals();
        document.getElementById("freeValue").value = "";
        setTimeout(jumpToTop, 100); 
    });

    // 4åˆ—ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®: [ç©º, ç©º, C, AC]
    controlBtnsArea.appendChild(empty1);
    controlBtnsArea.appendChild(empty2);
    controlBtnsArea.appendChild(btnC);
    controlBtnsArea.appendChild(btnAC);
}

/* ===== render free buttons ===== */
function renderFreeButtons(){
  freeBtnsArea.innerHTML = "";
  cfg.freeButtons.forEach((fb, idx)=>{
    const b = document.createElement("button");
    b.className = "coeff";
    b.innerHTML = `<div style="font-size:14px">${escapeHtml(fb.name)}</div><div style="font-size:13px;margin-top:6px;color:var(--dark-btn)">Ã—${fb.coeff}</div>`;
    b.addEventListener("click", ()=>{
      const v = toInt(freeValue.value);
      if(!v){ alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå††ï¼‰ã€‚"); return; }
      const raw = v * Number(fb.coeff);
      const price = roundItem(fb.name, raw);
      addEntry({type:"free", name:fb.name, price});
      freeValue.value = "";
      setTimeout(jumpToTop, 300); 
    });
    freeBtnsArea.appendChild(b);
  });
}

/* ===== stack rendering ===== */
function renderStack(){
  stack.innerHTML = "";
  if(entries.length === 0){
    const p = document.createElement("div");
    p.className = "small";
    p.style.padding="8px";
    p.textContent = "ã¾ã é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    stack.appendChild(p);
    return;
  }
  entries.forEach((e, i)=>{
    const row = document.createElement("div");
    row.className = "entry";
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="label">${escapeHtml(e.name)}</div><div class="small" style="color:var(--muted);font-size:12px">${e.type==="free" ? "ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰": ""}</div></div><div style="display:flex;align-items:center"><div class="price">${Number(e.price).toLocaleString()} å††</div><button class="removeBtn" data-i="${i}">Ã—</button></div>`;
    stack.appendChild(row);
  });
  stack.querySelectorAll(".removeBtn").forEach(btn=>{
    btn.addEventListener("click", (ev)=>{
      const idx = Number(ev.currentTarget.dataset.i);
      entries.splice(idx,1);
      saveEntries();
      renderStack();
      renderTotals();
      setTimeout(jumpToTop, 100); 
    });
  });
}

/* totals */
function renderTotals(){
  let pre = 0;
  entries.forEach(e=> pre += Number(e.price||0));
  const taxRate = Number(cfg.taxRate || 0);
  const tax = Math.floor(pre * taxRate / 100);
  const tot = pre + tax;
  preTaxEl.textContent = fmt(pre);
  taxEl.textContent = fmt(tax);
  totalEl.textContent = fmt(tot);
  taxRateSpan.textContent = taxRate;
}

/* add entry */
function addEntry(item){
  item.price = toInt(item.price);
  item.price = roundItem(item.name, item.price);
  entries.push(item);
  saveEntries();
  renderStack();
  renderTotals();
}

/* settings modal logic */
const modal = document.getElementById("modal");
document.getElementById("openSettings").addEventListener("click", openSettings);
document.getElementById("closeModal").addEventListener("click", ()=>{ modal.style.display="none"; document.body.style.overflow=""; });

function openSettings(){
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";
  document.getElementById("taxInput").value = cfg.taxRate || 0;
  document.getElementById("roundMethod").value = cfg.roundMethod || "floor";
  renderButtonConfig();
  renderFreeConfig();
}

function renderButtonConfig(){
  const container = document.getElementById("buttonConfig");
  container.innerHTML = "";
  // 24å€‹ã®ãƒœã‚¿ãƒ³è¨­å®šã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  cfg.buttons.forEach((b,i)=>{
    const row = document.createElement("div");
    row.className = "form-row";
    row.innerHTML = `<div style="width:36px;color:var(--muted);font-size:1.1em;flex-shrink:0;">${i+1}</div>
      <input id="bn${i}" type="text" value="${escapeHtml(b.name)}">
      <input id="bv${i}" type="number" value="${b.price||0}" min="0">`;
    container.appendChild(row);
  });
}

function renderFreeConfig(){
  const container = document.getElementById("freeConfig");
  container.innerHTML = "";
  cfg.freeButtons.forEach((f,i)=>{
    const row = document.createElement("div");
    row.className = "form-row";
    row.innerHTML = `<div style="width:36px;color:var(--muted);font-size:1.1em;flex-shrink:0;">${i+1}</div>
      <input id="fn${i}" type="text" value="${escapeHtml(f.name)}">
      <input id="fc${i}" type="number" value="${f.coeff||1}" step="0.0001">`;
    container.appendChild(row);
  });
}

document.getElementById("saveSettingsBtn").addEventListener("click", ()=>{
  const tr = Number(document.getElementById("taxInput").value || 0);
  cfg.taxRate = tr;
  cfg.roundMethod = document.getElementById("roundMethod").value || "floor";
  cfg.buttons.forEach((b,i)=>{
    const nameEl = document.getElementById("bn"+i);
    const valEl = document.getElementById("bv"+i);
    if(nameEl) b.name = nameEl.value || b.name;
    if(valEl) b.price = Number(valEl.value) || 0;
  });
  cfg.freeButtons.forEach((f,i)=>{
    const nameEl = document.getElementById("fn"+i);
    const valEl = document.getElementById("fc"+i);
    if(nameEl) f.name = nameEl.value || f.name;
    if(valEl) f.coeff = Number(valEl.value) || 1;
  });
  saveCfg();
  renderButtons();
  renderControlButtons();
  renderFreeButtons();
  renderTotals();
  modal.style.display = "none";
  document.body.style.overflow = "";
});

/* ğŸ’¡ import/export config */
document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      let importedCfg = data;
      // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
      if(data.cfg){ importedCfg = data.cfg; } 
      
      // å¿…é ˆé …ç›®ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      if(!importedCfg || !Array.isArray(importedCfg.buttons) || !Array.isArray(importedCfg.freeButtons)){
          alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
      }
      
      // è¨­å®šã‚’ä¸Šæ›¸ãã—ã€ä¸è¶³ã—ã¦ã„ã‚‹ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°DEFAULTã‹ã‚‰è£œå……
      cfg = Object.assign({}, cfg, importedCfg);
      if (cfg.buttons.length < DEFAULT.buttons.length) {
          const startIdx = cfg.buttons.length;
          for (let i = startIdx; i < DEFAULT.buttons.length; i++) {
              cfg.buttons.push(DEFAULT.buttons[i]);
          }
      }

      saveCfg(); 
      renderButtons(); 
      renderButtonConfig(); 
      renderFreeButtons(); 
      renderFreeConfig(); 
      renderTotals();

      alert("è¨­å®šã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    }catch(err){ 
      alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒä¸æ­£ã§ã™ã€‚\n" + err.message) 
    }
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
    ev.target.value = ''; 
  };
  r.readAsText(f,"utf-8");
});

document.getElementById("exportSettingsBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(cfg,null,2)], {type:"application/json"});
  const a = document.createElement("a"); 
  a.href = URL.createObjectURL(blob); 
  // ãƒ•ã‚¡ã‚¤ãƒ«å: rewardcfg_YYYY-MM-DD-HH-MM-SS.json ã®å½¢å¼
  a.download = `rewardcfg_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; 
  a.click();
  alert("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
});
/* ğŸ’¡ end import/export config */


/* init */
renderButtons();
renderControlButtons(); 
renderFreeButtons();
renderStack();
renderTotals();

/* helpers */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
